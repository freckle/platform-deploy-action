description: Deploy using the Freckle Platform CLI
inputs:
  platform-version:
    description: Version of Platform CLI to install
    required: true
    default: latest
  platform-suffix:
    description: OS-specific suffix for Platform package archive
    required: true
    default: x86_64-linux
  app-directory:
    description: Directory containing the App's .platform
    required: true
    default: "."
  app-resource:
    description: --resource option
    required: true
    default: ""
  environment:
    description: Environment to deploy (default prod)
    required: true
    default: prod
  deploy-tag:
    description: Tag to deploy (default is github.sha)
    required: true
    default: ""
  slack-webhook:
    description: Slack Webhook URL, will not notify if empty
    required: true
    default: ''
outputs: {}
runs:
  using: composite
  steps:
    - uses: freckle/setup-platform-action@v4
      with:
        version: ${{ inputs.platform-version }}
        suffix: ${{ inputs.platform-suffix }}
    - shell: bash
      run: |
        options=( --environment '${{ inputs.environment }}' )

        # Check if we support --color
        if platform --color always version &>/dev/null; then
          options+=( --color always )
        fi

        if [[ -n '${{ inputs.app-resource }}' ]]; then
          options+=( --resource '${{ inputs.app-resource }}' )
        fi

        tag=${{ inputs.deploy-tag }}
        tag=${tag:-${{ github.sha }}}

        options+=( deploy --tag "$tag" --no-confirm )

        cd '${{ inputs.app-directory }}'
        platform "${options[@]}"
    - if: ${{ always() && inputs.slack-webhook }}
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_COLOR: ${{ job.status }}
        SLACK_ICON: https://github.com/freckle-automation.png?size=48
        SLACK_USERNAME: GitHub Actions
        SLACK_TITLE: ${{ github.repository }} deployment
        SLACK_MESSAGE: ${{ job.status }}
        SLACK_FOOTER: ''
        SLACK_WEBHOOK: ${{ inputs.slack-webhook }}
        MSG_MINIMAL: actions url,commit
